/**
 * @fileoverview Prevent usage of Meteor.setTimeout with zero delay
 * @author Dominik Ferber
 */

'use strict';

var _utilEnvironment = require('../util/environment');

var _util = require('../util');

var _utilAst = require('../util/ast');

// -----------------------------------------------------------------------------
// Rule Definition
// -----------------------------------------------------------------------------

module.exports = function (getMeta) {
  return function (context) {
    var _getMeta = getMeta(context);

    var env = _getMeta.env;

    // -------------------------------------------------------------------------
    // Public
    // -------------------------------------------------------------------------

    if (env === _utilEnvironment.NON_METEOR) {
      return {};
    }

    return {

      CallExpression: function CallExpression(node) {
        if ((0, _utilAst.isMeteorCall)(node, 'setTimeout')) {
          var executors = (0, _util.getExecutors)(env, context.getAncestors());
          if (!executors.has('browser') && !executors.has('cordova')) {
            return;
          }

          if (node.arguments.length === 1) {
            context.report(node, 'Implicit timeout of 0');
          } else if (node.arguments.length > 1 && node.arguments[1].type === 'Literal' && node.arguments[1].value === 0) {
            context.report(node, 'Timeout of 0. Use `Meteor.defer` instead');
          }
        }
      }

    };
  };
};

module.exports.schema = [];